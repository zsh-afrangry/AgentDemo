# 模块说明

> 本文档描述各模块的输入、输出、依赖与调用关系。
> 系统主线：Schema 理解 → 问题库生成 → 任务识别 → Text-to-SQL → 可视化 → 学习优化

---

## 🧩 1. Schema Parser 模块（schema_parser.py）

**功能**  
从多个数据库中解析表结构、字段、注释，输出统一的 Schema JSON。

**输入**
- MySQL / PostgreSQL 数据库连接信息（来自 config/settings.json）

**输出**
- `/data/schema_json/{DB_NAME}_schema.json`

**依赖**
- `db_connection.py`：执行信息提取
- `file_io.py`：保存JSON

**调用**
- 被 `schema_understanding.py` 调用，生成语义图谱。

---

## 🧠 2. Schema Understanding 模块（schema_understanding.py）

**功能**  
基于Schema结构生成“字段语义+表间关系”认知图谱。

**输入**
- 各数据库 schema JSON

**输出**
- `schema_graph.json`（字段语义、关联关系）

**依赖**
- `schema_parser.py`
- `logger.py`

**调用**
- 被 `problem_generator.py` 和 `clustering.py` 调用

---

## 🧩 3. Problem Generator 模块（problem_generator.py）

**功能**  
基于规则样例和Schema图谱生成预设问题库。

**输入**
- `schema_graph.json`
- `human_rules.txt`

**输出**
- `generated_problems.json`

**依赖**
- `schema_understanding.py`
- `problem_templates.py`
- `file_io.py`

**调用**
- 后端API `/generate_problems`
- 被 Text-to-SQL 模块读取以理解冲突逻辑

---

## 🔍 4. Clustering 模块（clustering.py）

**功能**  
识别用户任务类型（对账/稽核/资格检测）并聚类相关表与字段。

**输入**
- 用户自然语言请求
- `schema_graph.json`

**输出**
- `task_type.json`
- `task_related_tables.json`
- `task_data_view.json`

**依赖**
- `schema_understanding.py`
- LLM 模型（任务分类）

**调用**
- 提供上下文给 Text-to-SQL 模块

---

## 🧠 5. Prompt Rewriter 模块（prompt_rewriter.py）

**功能**  
将中文自然语言请求改写为LLM可理解的SQL生成提示。

**输入**
- 用户原始需求（中文）

**输出**
- `rewritten_prompt.txt`

**依赖**
- 历史成功样本 `prompt_refine_dataset.json`
- 模型（Qwen / Claude / LLaMA）

**调用**
- `sql_generator.py`

---

## 🧮 6. SQL Generator 模块（sql_generator.py）

**功能**  
根据提示生成SQL语句。

**输入**
- `rewritten_prompt.txt`

**输出**
- `generated.sql`

**依赖**
- 模型API (dashscope / OpenAI / Ollama)
- `logger.py`

**调用**
- `sql_validator.py` 执行验证

---

## 🧰 7. SQL Validator / Debugger 模块（sql_validator.py + debugger.py）

**功能**  
验证SQL可执行性，捕获错误并自动修复。

**输入**
- `generated.sql`

**输出**
- `valid_sql.sql`
- `analysis_log.txt`

**依赖**
- `db_connection.py`
- `logger.py`

**调用**
- 返回修正SQL供报告生成模块使用

---

## 📊 8. Report Builder 模块（report_builder.py）

**功能**  
整合所有智能体检测结果生成最终违规报告。

**输入**
- 各Agent结果（binary / process / quantitative等）

**输出**
- `conflict_report.json`

**依赖**
- 各子模块执行结果
- `file_io.py`

**调用**
- `visualizer.py` 和前端API

---

## 🌐 9. Visualizer 模块（visualizer.py）

**功能**  
为前端提供违规结果接口与可视化数据。

**输入**
- `conflict_report.json`

**输出**
- REST API 响应 JSON

**依赖**
- `FastAPI`
- `report_builder.py`

**调用**
- 前端 `ResultView.vue` / `Dashboard.vue`

---

## 🔁 10. Feedback 模块（feedback.py）

**功能**  
收集人工标注反馈，持续优化模型。

**输入**
- 用户反馈结果
- 违规判定修正数据

**输出**
- `feedback.json`
- `self_refine_dataset.json`

**依赖**
- 所有上游模块的输出
- `file_io.py`

**调用**
- 持续学习机制入口

---

## 🔧 11. 支撑模块

| 模块 | 文件 | 功能 |
|------|------|------|
| 数据库连接 | db_connection.py | 多库连接池管理 |
| 文件读写 | file_io.py | JSON/TXT 文件管理 |
| 日志系统 | logger.py | 模块运行日志 |
| 配置管理 | config_loader.py / settings.json | 环境与路径参数 |
| 智能体配置 | agents_config.json | 控制启用哪些Agent |

---

## 📈 模块调用关系简图

